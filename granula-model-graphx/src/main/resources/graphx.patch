From d4fc011926fcde9c1ae79f177b0284a3b835a341 Mon Sep 17 00:00:00 2001
From: Wing Lung Ngai <winglung.ngai@gmail.com>
Date: Tue, 16 Feb 2016 15:20:02 +0100
Subject: [PATCH] granularized

---
 core/pom.xml                                       |  2 +-
 .../scala/org/apache/spark/GranulaLogger.scala     | 40 +++++++++++++++++
 .../main/scala/org/apache/spark/SparkContext.scala |  6 +++
 .../org/apache/spark/scheduler/DAGScheduler.scala  |  7 +++
 graphx/pom.xml                                     |  2 +-
 launcher/pom.xml                                   |  2 +-
 network/common/pom.xml                             |  2 +-
 network/shuffle/pom.xml                            |  2 +-
 network/yarn/pom.xml                               |  2 +-
 pom.xml                                            | 52 +++++++++++-----------
 tags/pom.xml                                       |  2 +-
 unsafe/pom.xml                                     |  2 +-
 yarn/pom.xml                                       |  2 +-
 13 files changed, 88 insertions(+), 35 deletions(-)
 create mode 100644 core/src/main/scala/org/apache/spark/GranulaLogger.scala

diff --git a/core/pom.xml b/core/pom.xml
index 15b8d75..a97526f 100644
--- a/core/pom.xml
+++ b/core/pom.xml
@@ -21,7 +21,7 @@
   <parent>
     <groupId>org.apache.spark</groupId>
     <artifactId>spark-parent_2.10</artifactId>
-    <version>1.6.0</version>
+    <version>1.6.0-withGranula</version>
     <relativePath>../pom.xml</relativePath>
   </parent>
 
diff --git a/core/src/main/scala/org/apache/spark/GranulaLogger.scala b/core/src/main/scala/org/apache/spark/GranulaLogger.scala
new file mode 100644
index 0000000..88b14fb
--- /dev/null
+++ b/core/src/main/scala/org/apache/spark/GranulaLogger.scala
@@ -0,0 +1,40 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.spark
+
+class GranulaLogger(aType: String, aId: String,
+                     mType: String, mId: String) extends Logging {
+
+  var actorType = aType;
+  var actorId = aId;
+  var missionType = mType;
+  var missionId = mId;
+
+  def log(infoName: String, infoValue: String) {
+    val escapedValue = infoValue.replaceAll(":", "\\[COLON\\]").replaceAll("\\s+", "\\[SPACE\\]");
+    logInfo("GRANULA - InfoName:%s InfoValue:%s".format(infoName, escapedValue) +
+      " ActorType:%s ActorId:%s MissionType:%s MissionId:%s"
+        .format(actorType, actorId, missionType, missionId) +
+      s" Timestamp:${System.currentTimeMillis()}")
+  }
+
+//  def trace(callSite: String): String = {
+//    callSite.replace('\n', '#').replace("\\s+", "#").replace(' ', '#').replace(':', '@')
+//  }
+
+}
diff --git a/core/src/main/scala/org/apache/spark/SparkContext.scala b/core/src/main/scala/org/apache/spark/SparkContext.scala
index 8a62b71..3f9a617 100644
--- a/core/src/main/scala/org/apache/spark/SparkContext.scala
+++ b/core/src/main/scala/org/apache/spark/SparkContext.scala
@@ -78,6 +78,9 @@ import org.apache.spark.util._
  */
 class SparkContext(config: SparkConf) extends Logging with ExecutorAllocationClient {
 
+  val appLogger = new GranulaLogger("SparkApp", "Id.Unique", "SparkJob", "Id.Unique");
+  appLogger.log("StartTime", s"${System.currentTimeMillis()}");
+
   // The call site where this SparkContext was constructed.
   private val creationSite: CallSite = Utils.getCallSite()
 
@@ -1757,6 +1760,9 @@ class SparkContext(config: SparkConf) extends Logging with ExecutorAllocationCli
       }
       SparkEnv.set(null)
     }
+
+    val appLogger = new GranulaLogger("SparkApp", "Id.Unique", "SparkJob", "Id.Unique");
+    appLogger.log("EndTime", s"${System.currentTimeMillis()}");
     // Unset YARN mode system env variable, to allow switching between cluster types.
     System.clearProperty("SPARK_YARN_MODE")
     SparkContext.clearActiveContext()
diff --git a/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala b/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala
index b805bde..3200b17 100644
--- a/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala
+++ b/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala
@@ -918,6 +918,10 @@ class DAGScheduler(
         logDebug("missing: " + missing)
         if (missing.isEmpty) {
           logInfo("Submitting " + stage + " (" + stage.rdd + "), which has no missing parents")
+          val stageId = stage.id
+          val stageLogger = new GranulaLogger("Scheduler", s"$stageId", "Stage", s"$stageId");
+          stageLogger.log("StartTime", s"${System.currentTimeMillis()}")
+
           submitMissingTasks(stage, jobId.get)
         } else {
           for (parent <- missing) {
@@ -1383,6 +1387,9 @@ class DAGScheduler(
     }
     if (errorMessage.isEmpty) {
       logInfo("%s (%s) finished in %s s".format(stage, stage.name, serviceTime))
+      val stageId = stage.id
+      val stageLogger = new GranulaLogger("Scheduler", s"$stageId", "Stage", s"$stageId");
+      stageLogger.log("EndTime", s"${System.currentTimeMillis()}")
       stage.latestInfo.completionTime = Some(clock.getTimeMillis())
 
       // Clear failure count for this stage, now that it's succeeded.
diff --git a/graphx/pom.xml b/graphx/pom.xml
index a66c86e..d317cc9 100644
--- a/graphx/pom.xml
+++ b/graphx/pom.xml
@@ -21,7 +21,7 @@
   <parent>
     <groupId>org.apache.spark</groupId>
     <artifactId>spark-parent_2.10</artifactId>
-    <version>1.6.0</version>
+    <version>1.6.0-withGranula</version>
     <relativePath>../pom.xml</relativePath>
   </parent>
 
diff --git a/launcher/pom.xml b/launcher/pom.xml
index 6bbf7cf..851a6fb 100644
--- a/launcher/pom.xml
+++ b/launcher/pom.xml
@@ -22,7 +22,7 @@
   <parent>
     <groupId>org.apache.spark</groupId>
     <artifactId>spark-parent_2.10</artifactId>
-    <version>1.6.0</version>
+    <version>1.6.0-withGranula</version>
     <relativePath>../pom.xml</relativePath>
   </parent>
 
diff --git a/network/common/pom.xml b/network/common/pom.xml
index 6d84f93..55f3a93 100644
--- a/network/common/pom.xml
+++ b/network/common/pom.xml
@@ -22,7 +22,7 @@
   <parent>
     <groupId>org.apache.spark</groupId>
     <artifactId>spark-parent_2.10</artifactId>
-    <version>1.6.0</version>
+    <version>1.6.0-withGranula</version>
     <relativePath>../../pom.xml</relativePath>
   </parent>
 
diff --git a/network/shuffle/pom.xml b/network/shuffle/pom.xml
index 00c141e..e2fcdff 100644
--- a/network/shuffle/pom.xml
+++ b/network/shuffle/pom.xml
@@ -22,7 +22,7 @@
   <parent>
     <groupId>org.apache.spark</groupId>
     <artifactId>spark-parent_2.10</artifactId>
-    <version>1.6.0</version>
+    <version>1.6.0-withGranula</version>
     <relativePath>../../pom.xml</relativePath>
   </parent>
 
diff --git a/network/yarn/pom.xml b/network/yarn/pom.xml
index e3644a4..e7fc7ae 100644
--- a/network/yarn/pom.xml
+++ b/network/yarn/pom.xml
@@ -22,7 +22,7 @@
   <parent>
     <groupId>org.apache.spark</groupId>
     <artifactId>spark-parent_2.10</artifactId>
-    <version>1.6.0</version>
+    <version>1.6.0-withGranula</version>
     <relativePath>../../pom.xml</relativePath>
   </parent>
 
diff --git a/pom.xml b/pom.xml
index bbee213..fdf3644 100644
--- a/pom.xml
+++ b/pom.xml
@@ -26,7 +26,7 @@
   </parent>
   <groupId>org.apache.spark</groupId>
   <artifactId>spark-parent_2.10</artifactId>
-  <version>1.6.0</version>
+  <version>1.6.0-withGranula</version>
   <packaging>pom</packaging>
   <name>Spark Project Parent POM</name>
   <url>http://spark.apache.org/</url>
@@ -86,33 +86,33 @@
   </mailingLists>
 
   <modules>
-    <module>tags</module>
+    <!--<module>tags</module>-->
     <module>core</module>
-    <module>bagel</module> <!-- Deprecated -->
+    <!--<module>bagel</module> &lt;!&ndash; Deprecated &ndash;&gt;-->
     <module>graphx</module>
-    <module>mllib</module>
-    <module>tools</module>
-    <module>network/common</module>
-    <module>network/shuffle</module>
-    <module>streaming</module>
-    <module>sql/catalyst</module>
-    <module>sql/core</module>
-    <module>sql/hive</module>
-    <module>docker-integration-tests</module>
-    <module>unsafe</module>
-    <module>assembly</module>
-    <module>external/twitter</module>
-    <module>external/flume</module>
-    <module>external/flume-sink</module>
-    <module>external/flume-assembly</module>
-    <module>external/mqtt</module>
-    <module>external/mqtt-assembly</module>
-    <module>external/zeromq</module>
-    <module>examples</module>
-    <module>repl</module>
-    <module>launcher</module>
-    <module>external/kafka</module>
-    <module>external/kafka-assembly</module>
+    <!--<module>mllib</module>-->
+    <!--<module>tools</module>-->
+    <!--<module>network/common</module>-->
+    <!--<module>network/shuffle</module>-->
+    <!--<module>streaming</module>-->
+    <!--<module>sql/catalyst</module>-->
+    <!--<module>sql/core</module>-->
+    <!--<module>sql/hive</module>-->
+    <!--<module>docker-integration-tests</module>-->
+    <!--<module>unsafe</module>-->
+    <!--<module>assembly</module>-->
+    <!--<module>external/twitter</module>-->
+    <!--<module>external/flume</module>-->
+    <!--<module>external/flume-sink</module>-->
+    <!--<module>external/flume-assembly</module>-->
+    <!--<module>external/mqtt</module>-->
+    <!--<module>external/mqtt-assembly</module>-->
+    <!--<module>external/zeromq</module>-->
+    <!--<module>examples</module>-->
+    <!--<module>repl</module>-->
+    <!--<module>launcher</module>-->
+    <!--<module>external/kafka</module>-->
+    <!--<module>external/kafka-assembly</module>-->
   </modules>
 
   <properties>
diff --git a/tags/pom.xml b/tags/pom.xml
index 8d1a107..7f433a8 100644
--- a/tags/pom.xml
+++ b/tags/pom.xml
@@ -22,7 +22,7 @@
   <parent>
     <groupId>org.apache.spark</groupId>
     <artifactId>spark-parent_2.10</artifactId>
-    <version>1.6.0</version>
+    <version>1.6.0-withGranula</version>
     <relativePath>../pom.xml</relativePath>
   </parent>
 
diff --git a/unsafe/pom.xml b/unsafe/pom.xml
index 4e9c73c..588d3b5 100644
--- a/unsafe/pom.xml
+++ b/unsafe/pom.xml
@@ -22,7 +22,7 @@
   <parent>
     <groupId>org.apache.spark</groupId>
     <artifactId>spark-parent_2.10</artifactId>
-    <version>1.6.0</version>
+    <version>1.6.0-withGranula</version>
     <relativePath>../pom.xml</relativePath>
   </parent>
 
diff --git a/yarn/pom.xml b/yarn/pom.xml
index 8bc520d..552b9d8 100644
--- a/yarn/pom.xml
+++ b/yarn/pom.xml
@@ -20,7 +20,7 @@
   <parent>
     <groupId>org.apache.spark</groupId>
     <artifactId>spark-parent_2.10</artifactId>
-    <version>1.6.0</version>
+    <version>1.6.0-withGranula</version>
     <relativePath>../pom.xml</relativePath>
   </parent>
 
-- 
1.9.1

